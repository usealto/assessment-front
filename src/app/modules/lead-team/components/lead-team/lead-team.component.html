<div class="header-panel">
  <img [src]="Emoji.BustsInSilhouette | emoji" height="32" />
  <h1 data-cy="leadTeamTitle">{{ I18ns.leadTeam.title }}</h1>
</div>

<!-- TEAMS -->
<div>
  <button type="button" class="btn btn-primary float-end" (click)="openTeamForm()">
    <i data-cy="createTeam" class="bi bi-plus-lg"></i><span>{{ I18ns.leadTeam.createTeam }}</span>
  </button>
  <h2 id="teamsAnchor" class="me-3">
    <img class="emoji" [src]="Emoji.BustsInSilhouette | emoji" /> {{ I18ns.leadTeam.teams.title }}
  </h2>
  <p class="mb-5 alto-grey">{{ I18ns.leadTeam.teams.subtitle }}</p>

  <alto-placeholder-manager [status]="teamsDataStatus">
    <div class="table-panel">
      <table class="table team-table">
        <thead>
          <tr>
            <th scope="col" class="w-25">{{ I18ns.leadTeam.teams.table.name }}</th>
            <th scope="col" class="w-20 text-center">
              {{ I18ns.leadTeam.teams.table.globalScore }}
            </th>
            <th scope="col" class="w-20 text-start">{{ I18ns.leadTeam.teams.table.usersCount }}</th>
            <th scope="col" class="w-25 text-center">{{ I18ns.leadTeam.teams.table.activity }}</th>
            <th scope="col" class="w-10 text-start">{{ I18ns.leadTeam.teams.table.creationDate }}</th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let team of paginatedTeams" class="align-middle fs-7">
            <td data-cy="teamLongname">{{ team.name }}</td>
            <td>
              <div *ngIf="team.score" class="text-center">
                <span class="alto-score" [class]="(team.score || 0) * 100 | pillColor">
                  {{ team.score | percent }}
                </span>
              </div>
              <div class="text-center" *ngIf="!team.score">
                {{ I18ns.leadTeam.teams.table.noScore }}
              </div>
            </td>
            <td class="w-20 text-start">
              <div *ngIf="getTeamUsersCount(team.id) !== 0">
                {{ I18ns.leadTeam.teams.table.users | plural : getTeamUsersCount(team.id) }}
                {{ I18ns.shared.members }}
              </div>
              <div *ngIf="getTeamUsersCount(team.id) === 0">
                {{ I18ns.leadTeam.teams.table.noUsers }}
              </div>
            </td>
            <td>
              <div *ngIf="team.totalGuessesCount && team.questionsPushedCount" class="text-center">
                {{ (team.totalGuessesCount / team.questionsPushedCount) * 100 | number : '1.0-0' }}
              </div>
              <div class="text-center" *ngIf="!team.totalGuessesCount || !team.questionsPushedCount">
                {{ I18ns.leadTeam.teams.table.noActivity }}
              </div>
            </td>
            <td class="text-start">
              {{ team.createdAt | date : 'shortDate' }}
            </td>
            <td class="cursor-pointer px-3" (click)="deleteTeam(team)">
              <i [attr.data-cy]="'deleteTeam' + team.name" class="fs-5 bi bi-trash3 float-end"></i>
            </td>
            <td class="cursor-pointer px-3" (click)="openTeamForm(team)">
              <i data-cy="editTeam" class="fs-5 bi bi-pen float-end me-4"></i>
            </td>
          </tr>
        </tbody>
      </table>
      <alto-pagination
        class="mx-4 d-block"
        [collectionSize]="teams.length"
        (pageChange)="changeTeamsPage($event)"
        [pageSize]="teamsPageSize"
        [page]="teamsPage"
      ></alto-pagination>
    </div>

    <div class="nodata-placeholder text-center" noData>
      <img [src]="Emoji.Eyes | emoji" height="24" />
      <p class="mt-3">{{ I18ns.leadTeam.teams.table.placeholderTitle }}</p>
      <span class="mt-3 d-block">{{ I18ns.leadTeam.teams.table.placeholderSubtitle }}</span>
      <button type="button" class="btn btn-primary mt-4" (click)="openTeamForm()">
        <i class="bi bi-plus-lg"></i>{{ I18ns.leadTeam.createTeam }}
      </button>
    </div>
    <div class="skeleton-panel" style="height: 296px" loading></div>
  </alto-placeholder-manager>
</div>

<!-- MEMBERS -->

<div class="mb-5 members">
  <button
    type="button"
    class="btn btn-primary float-end d-flex align-items-center"
    (click)="airtableRedirect()"
  >
    <i class="bi bi-person-plus me-2 fs-5"></i>
    <span>{{ I18ns.leadTeam.members.invite }}</span>
  </button>
  <h2 data-cy="companyMembersSection" id="membersAnchor">
    <img class="emoji" [src]="Emoji.BustsInSilhouette | emoji" />
    {{ I18ns.leadTeam.members.title }}
  </h2>
  <p class="alto-grey">{{ I18ns.leadTeam.members.subtitle }}</p>
</div>

<alto-placeholder-manager [status]="usersDataStatus">
  <div class="panel mb-5 align-items-center">
    <div class="border-end">
      <alto-icon-badge [size]="4" icon="bi bi-people-fill" class="me-4"></alto-icon-badge>
      <div>
        <p class="alto-grey mb-2">{{ I18ns.leadTeam.members.statistics.total }}</p>
        <h1 class="mb-0">{{ absoluteUsersCount }}</h1>
      </div>
    </div>
    <div class="second-col">
      <alto-icon-badge [size]="4" class="me-4" icon="bi-reply-all-fill"></alto-icon-badge>

      <div class="flex-grow-1">
        <p class="alto-grey mb-2">{{ I18ns.leadTeam.members.statistics.totalAnswers }}</p>
        <h1 class="mb-0 d-inline-block">{{ usersTotalQuestions }}</h1>
        <alto-progression-badge
          class="float-end"
          [score]="usersTotalQuestionsProgression"
        ></alto-progression-badge>
      </div>
    </div>
  </div>

  <div class="row mb-5">
    <div class="col-6">
      <alto-search
        data-cy="filterBySearch"
        class="float-start"
        [searchItems]="userFilters.search"
        (searchChange)="filterUsers({ search: $event })"
      ></alto-search>
    </div>

    <div class="col-6 text-end">
      <alto-dropdown-filter
        data-cy="filterByTeam"
        class="me-3 text-start"
        [data]="teams"
        [displayLabel]="'name'"
        [isColored]="true"
        [placeholder]="I18ns.leadTeam.members.filters.teams"
        [selectedItems]="selectedItems"
        (selectChange)="filterUsers({ teams: $event })"
      ></alto-dropdown-filter>

      <alto-score-filter
        class="text-start"
        data-cy="filterByScore"
        [selectedItems]="selectedItems"
        (selectChange)="filterUsers({ score: $event })"
      ></alto-score-filter>
    </div>
  </div>

  <div class="table-panel">
    <table class="table members-table">
      <thead>
        <tr>
          <th scope="col" class="w-25">{{ I18ns.leadTeam.members.table.name }}</th>
          <th scope="col" class="w-25">{{ I18ns.leadTeam.members.table.team }}</th>
          <th scope="col" class="w-25 text-center">
            {{ I18ns.leadTeam.members.table.globalScore }}
          </th>
          <th scope="col" class="w-25">
            {{ I18ns.leadTeam.members.table.questionsPerMonth }}
            <i
              class="ms-2 alto-grey bi bi-question-circle"
              ngbTooltip="{{ I18ns.leadTeam.members.table.questionsPerMonthTooltip }}"
            ></i>
          </th>
          <th class="w-5"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of paginatedUsers" class="align-middle" data-cy="companyMembersTable">
          <td>
            <alto-profile-card data-cy="profileCard" [user]="user.user"></alto-profile-card>
          </td>
          <td>
            <span data-cy="memberTeamName" class="alto-badge" [style]="user.teamId || '' | teamColor">
              {{ usersMap.get(user.id) }}
            </span>
          </td>
          <td class="text-center">
            <ng-container *ngIf="(user.totalGuessesCount || 0) > 0; else elseTemplate">
              <span data-cy="progressBadge" class="alto-score" [class]="(user.score || 0) * 100 | pillColor">
                {{ user.score | percent }}
              </span>
            </ng-container>
            <ng-template #elseTemplate>
              {{ I18ns.leadTeam.members.table.noScore }}
            </ng-template>
          </td>
          <td>
            <span class="w-10 d-inline-block">
              {{ user.totalGuessesCount }}
            </span>
            <alto-progression-badge
              class="d-inline-block ms-3"
              [score]="getQuestionsByUser(user.id, user.totalGuessesCount)"
            ></alto-progression-badge>
          </td>
          <td>
            <i
              data-cy="editCompanyMember"
              class="fs-5 bi bi-pen cursor-pointer float-end me-4"
              (click)="openUserEditionForm(user)"
            ></i>
          </td>
        </tr>
      </tbody>
    </table>

    <alto-pagination
      class="mx-4 d-block"
      [collectionSize]="usersCount"
      (pageChange)="changeUsersPage(filteredUsers, $event)"
      [pageSize]="usersPageSize"
      [page]="usersPage"
    ></alto-pagination>
  </div>

  <div *ngIf="!isFilteredUsers" class="nodata-placeholder text-center" noData>
    <img [src]="Emoji.Eyes | emoji" height="24" />
    <p class="mt-3">{{ I18ns.leadTeam.members.table.placeholderTitle }}</p>
    <span class="mt-3 d-block">{{ I18ns.leadTeam.members.table.placeholderSubtitle }}</span>
    <button type="button" class="btn btn-primary mt-4" (click)="openTeamForm()">
      <i class="bi bi-plus-lg"></i>{{ I18ns.leadTeam.createTeam }}
    </button>
  </div>
  <div *ngIf="isFilteredUsers" class="nodata-placeholder text-center" noResult>
    <img [src]="Emoji.MagnifyingGlassTiltedLeft | emoji" height="24" />
    <p class="mt-3">{{ I18ns.shared.noData }}</p>
    <span class="mt-3 d-block">{{ I18ns.shared.noDataSubtitle }}</span>
    <button class="btn btn-primary mt-4" (click)="resetFilters()">
      <i class="bi bi-arrow-clockwise"></i>
      {{ I18ns.shared.resetFilters }}
    </button>
  </div>
  <div style="height: 542px" loading>
    <div class="skeleton-panel mb-5" style="height: 82px" loading></div>
    <div class="row mb-5">
      <div class="col-6">
        <alto-search class="float-start"></alto-search>
      </div>
      <div class="col-6 text-end">
        <alto-dropdown-filter class="me-3 text-start"></alto-dropdown-filter>

        <alto-score-filter class="text-start"></alto-score-filter>
      </div>
    </div>
    <div class="skeleton-panel" style="height: 356px"></div>
  </div>
</alto-placeholder-manager>
