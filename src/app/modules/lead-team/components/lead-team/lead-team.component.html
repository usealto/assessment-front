<div class="welcome-panel">
  <h1 data-cy="leadTeamTitle">{{ I18ns.leadTeam.titleIcon }} {{ I18ns.leadTeam.title }}</h1>
</div>

<div class="gap"></div>
<!-- TEAMS -->
<div>
  <button type="button" class="btn btn-primary float-end" (click)="openTeamForm()">
    <i class="bi bi-plus-lg"></i> {{ I18ns.leadTeam.createTeam }}
  </button>
  <h2 id="teamsAnchor">{{ I18ns.leadTeam.teams.titleIcon }} {{ I18ns.leadTeam.teams.title }}</h2>
  <p class="mb-4 alto-grey">{{ I18ns.leadTeam.teams.subtitle }}</p>
  <ng-container *ngIf="paginatedTeams.length > 0; else noTeams">
    <div class="table-panel">
      <table class="table">
        <thead>
          <tr>
            <th scope="col" class="w-30">{{ I18ns.leadTeam.teams.table.name }}</th>
            <th scope="col" class="w-20 text-center">{{ I18ns.leadTeam.teams.table.globalScore }}</th>
            <th scope="col" class="w-20 text-center">{{ I18ns.leadTeam.teams.table.usersCount }}</th>
            <th scope="col" class="w-25 text-center">{{ I18ns.leadTeam.teams.table.averageScore }}</th>
            <th scope="col" class="text-center">{{ I18ns.leadTeam.teams.table.creationDate }}</th>
            <th class="w-5"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let team of paginatedTeams" class="align-middle">
            <td data-cy="teamLongname" class="fw-medium">
              {{ team.longName }}
            </td>
            <td>

            </td>
            <td class="w-20 text-center">
              <div *ngIf="getTeamUsersCount(team.id) !== 0">
                {{ I18ns.leadTeam.teams.table.users | plural : getTeamUsersCount(team.id) }} membres
              </div>
              <div *ngIf="getTeamUsersCount(team.id) === 0">
                {{ I18ns.leadTeam.teams.table.noUsers }}
              </div>
            </td>
            <td>
              <div class="progress" *ngIf="team.score">
                <div
                  class="progress-bar d-inline-block"
                  role="progressbar"
                  [style]="'width:' + team.score * 100 + '%'"
                ></div>
              </div>
              <ng-container *ngIf="team.score"> {{ team.score | percent }}</ng-container>
              <div class="text-center" *ngIf="!team.score">
                {{ I18ns.leadTeam.teams.table.noScore }}
              </div>
            </td>
            <td class="text-center">
              {{ team.createdAt | date : 'shortDate' }}
            </td>
            <td>
              <i
                data-cy="editTeam"
                class="fs-5 bi bi-pencil cursor-pointer float-end me-4"
                (click)="openTeamForm(team)"
              ></i>
            </td>
          </tr>
        </tbody>
      </table>
      <alto-pagination
        class="mx-4 d-block"
        [collectionSize]="teams.length"
        (pageChange)="changeTeamsPage($event)"
        [pageSize]="teamsPageSize"
        [page]="teamsPage"
      ></alto-pagination>
    </div>
  </ng-container>
  <ng-template #noTeams>
    <div class="panel text-center">
      <h2>{{ I18ns.shared.noData }}</h2>
      <p>{{ I18ns.shared.noDataSubtitle }}</p>
    </div>
  </ng-template>
</div>

<div class="gap"></div>

<!-- MEMBERS -->

<div>
  <button
    type="button"
    class="btn btn-primary float-end d-flex align-items-center"
    (click)="airtableRedirect()"
  >
    <i class="bi bi-person-plus me-2 fs-5"></i>
    <span>{{ I18ns.leadTeam.members.invite }}</span>
  </button>
  <h2 data-cy="companyMembersSection" id="membersAnchor">{{ I18ns.leadTeam.members.titleIcon }} {{ I18ns.leadTeam.members.title }}</h2>
  <p class="mb-3 alto-grey">{{ I18ns.leadTeam.members.subtitle }}</p>

  <div class="row py-4">
  <div class="col-12">
    <div class="card">
      <div class="row">
        <div class="col-6 position-relative short-border-end">
          <div class="panel d-flex align-items-center">
            <div class="double-badge me-4">
              <i class="alto-badge-blue bi bi-bar-chart-fill"></i>
            </div>
            <div>
              <p class="alto-grey mb-3">{{ I18ns.leadTeam.members.statistics.total }}</p>
              <h1>{{ absoluteUsersCount }}</h1>
            </div>
          </div>

        </div>
        <div class="col-6 ">
          <div class="panel d-flex align-items-center">
            <div class="double-badge me-4">
              <i class="alto-badge-big alto-badge-blue bi bi-reply-all-fill"></i>
            </div>
            <div class="info-wrapper">
              <p class="alto-grey mb-3">{{ I18ns.leadTeam.members.statistics.totalAnswers }}</p>
              <div class="info-stats">
                <h1>{{ getTotalQuestions() }}</h1>
                <alto-progression-badge
                  class="d-inline-block ms-3"
                  [score]="getPercentageQuestions()"
                ></alto-progression-badge>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <div class="mb-4 d-flex justify-content-between">
    <alto-search
      data-cy="filterBySearch"
      class="float-start"
      (searchChange)="filterUsers({ search: $event })"
    ></alto-search>

    <div>
      <alto-dropdown-filter
        data-cy="filterByTeam"
        class="d-inline-block me-3"
        [data]="teams"
        [displayLabel]="'shortName'"
        [isColored]="true"
        [placeholder]="I18ns.leadTeam.members.filters.teams"
        (selectChange)="filterUsers({ teams: $event })"
      ></alto-dropdown-filter>
  
      <alto-score-filter
        data-cy="filterByScore"
        (selectChange)="filterUsers({ score: $event })"
      ></alto-score-filter>
    </div>
  </div>

  <ng-container *ngIf="paginatedUsers.length > 0; else noUsers">
    <div class="table-panel">
      <table class="table">
        <thead>
          <tr>
            <th scope="col" class="w-35">{{ I18ns.leadTeam.members.table.name }}</th>
            <th scope="col" class="w-5">{{ I18ns.leadTeam.members.table.team }}</th>
            <th scope="col">
              {{ I18ns.leadTeam.members.table.averageScore }}
              <i
                class="ms-2 alto-grey bi bi-question-circle"
                ngbTooltip="{{ I18ns.leadTeam.members.table.averageScoreTooltip }}"
              ></i>
            </th>
            <th scope="col" class="text-center w-20">
              {{ I18ns.leadTeam.members.table.questionsPerMonth }}
              <i
                class="ms-2 alto-grey bi bi-question-circle"
                ngbTooltip="{{ I18ns.leadTeam.members.table.questionsPerMonthTooltip }}"
              ></i>
            </th>
            <th class="w-5"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of paginatedUsers" class="align-middle">
            <td>
              <alto-profile-card data-cy="profileCard" [user]="user"></alto-profile-card>
            </td>
            <td>
              <span data-cy="memberTeamShortname" class="alto-badge" [style]="user.teamId || '' | teamColor">
                {{ usersMap.get(user.id) }}
              </span>
            </td>
            <td>
              <div class="progress" *ngIf="user.score">
                <div
                  data-cy="scoreProgressBar"
                  class="progress-bar d-inline-block"
                  role="progressbar"
                  [style]="user.score && 'width:' + (user.score | percent : '1.0-0' : 'en-US')"
                ></div>
              </div>
              <ng-container *ngIf="user.score">{{ user.score | percent }}</ng-container>
              <div class="text-center" *ngIf="!user.score">
                {{ I18ns.leadTeam.members.table.noScore }}
              </div>
            </td>
            <td class="text-center">
              {{ getQuestionsByUser(user.id)[0] }}
              <alto-progression-badge
                class="d-inline-block ms-3"
                [score]="getQuestionsByUser(user.id)[1]"
              ></alto-progression-badge>
            </td>
            <td>
              <i
                data-cy="editCompanyMember"
                class="fs-5 bi bi-pencil cursor-pointer float-end me-4"
                (click)="openUserEditionForm(user)"
              ></i>
            </td>
          </tr>
        </tbody>
      </table>

      <alto-pagination
        class="mx-4 d-block"
        [collectionSize]="usersCount"
        (pageChange)="changeUsersPage(usersScores, $event)"
        [pageSize]="usersPageSize"
        [page]="usersPage"
      ></alto-pagination>
    </div>
  </ng-container>
  <ng-template #noUsers>
    <div class="panel text-center">
      <h2>{{ I18ns.shared.noData }}</h2>
      <p>{{ I18ns.shared.noDataSubtitle }}</p>
    </div>
  </ng-template>
</div>
