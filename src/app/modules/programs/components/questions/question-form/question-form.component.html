<div class="text-end px-4">
  <button type="button" class="btn-close" aria-label="Close" (click)="activeOffcanvas.dismiss()"></button>
</div>
<div class="row m-5 g-0">
  <div class="col-2" style="width: 2.857rem">
    <i class="alto-badge-big alto-badge-blue me-4 bi bi-question-circle"></i>
  </div>

  <div class="col ms-4">
    <h2>
      {{
        isSubmitted
          ? I18ns.questions.form.title.submitted
          : isEdit
          ? I18ns.questions.form.title.edit
          : I18ns.questions.form.title.create
      }}
    </h2>
    <p class="alto-grey">
      {{
        isSubmitted
          ? question?.createdByUser?.username + I18ns.questions.form.subtitle.submitted
          : I18ns.questions.form.subtitle.question
      }}
    </p>
  </div>
</div>
<hr />
<div class="offcanvas-body m-5">
  <div *ngIf="isSubmitted" class="mb-4 row">
    <alto-profile-card class="col-7" [user]="question?.createdByUser"> </alto-profile-card>
    <div class="col-5 text-end">
      <a type="button" class="btn btn-outline-secondary" [href]="'mailto:' + question?.createdByUser?.email">
        <i class="bi bi-reply-all-fill"></i> {{ I18ns.shared.reply }}
      </a>
    </div>
  </div>
  <form *ngIf="questionForm" [formGroup]="questionForm">
    <label class="form-label required">{{ I18ns.questions.form.name }}</label>
    <textarea
      class="form-control"
      formControlName="title"
      placeholder="{{ I18ns.questions.form.namePlaceholder }}"
      altoAutoResizeTextarea
    ></textarea>
    <label class="form-label required">{{ I18ns.questions.form.goodAnswer }}</label>

    <ng-container formArrayName="answersAccepted">
      <ng-container *ngFor="let answer of answersAccepted.controls; let i = index">
        <input
          type="text"
          class="form-control"
          [formControl]="answer"
          placeholder="{{ I18ns.questions.form.answerPlaceholder + ' ' + (i + 1) }}"
        />
      </ng-container>
    </ng-container>
    <p class="add-field" *ngIf="answersAccepted.controls.length < 4" (click)="addGoodAnwswer()">
      <i class="bi bi-plus"></i> {{ I18ns.questions.form.addGoodAnswer }}
    </p>

    <hr />

    <label class="form-label required">{{ I18ns.questions.form.badAnswer }}</label>

    <ng-container formArrayName="answersWrong">
      <ng-container *ngFor="let answer of answersWrong.controls; let i = index">
        <input
          type="text"
          class="form-control"
          [formControl]="answer"
          placeholder="{{ I18ns.questions.form.answerPlaceholder + ' ' + (i + 1) }}"
        />
      </ng-container>
    </ng-container>

    <p class="add-field" *ngIf="answersWrong.controls.length < 4" (click)="addBadAnwswer()">
      <i class="bi bi-plus"></i> {{ I18ns.questions.form.addBadAnswer }}
    </p>

    <hr />

    <label class="form-label">{{ I18ns.questions.form.programs }}</label>
    <ng-select
      class="alto-form mb-4"
      [items]="programs"
      [multiple]="true"
      bindLabel="name"
      [placeholder]="I18ns.questions.form.programsPlaceholder"
      [closeOnSelect]="false"
      bindValue="id"
      formControlName="programs"
    >
      <ng-template ng-label-tmp let-item="item" let-clear="clear">
        <div class="alto-badge">
          <span>{{ item.name }}</span>
          <span class="cursor-pointer ms-2 align-middle" (click)="clear(item)" aria-hidden="true">
            <i class="bi bi-x-lg"></i>
          </span>
        </div>
      </ng-template>
      <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
        <span class="alto-badge">{{ item.name }}</span>
        <i class="bi bi-check-circle-fill"></i>
      </ng-template>
    </ng-select>

    <label class="form-label required">{{ I18ns.questions.form.tags }}</label>
    <ng-select
      class="alto-form mb-4"
      required
      [items]="tags"
      [multiple]="true"
      bindLabel="name"
      [placeholder]="I18ns.questions.form.tagsPlaceholder"
      [selectableGroup]="true"
      [closeOnSelect]="false"
      bindValue="id"
      formControlName="tags"
    >
      <ng-template ng-label-tmp let-item="item" let-clear="clear">
        <div class="alto-badge">
          <span>{{ item.name }}</span>
          <span class="cursor-pointer ms-2 align-middle" (click)="clear(item)" aria-hidden="true">
            <i class="bi bi-x-lg"></i>
          </span>
        </div>
      </ng-template>
      <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
        <span class="alto-badge">{{ item.name }}</span>
        <i class="bi bi-check-circle-fill"></i>
      </ng-template>
    </ng-select>

    <label class="form-label">{{ I18ns.questions.form.explanation }}</label>
    <textarea
      class="form-control"
      rows="5"
      formControlName="explanation"
      placeholder="{{ I18ns.questions.form.explanationPlaceholder }}"
    ></textarea>

    <label class="form-label">{{ I18ns.questions.form.link }}</label>
    <input
      type="text"
      class="form-control"
      formControlName="link"
      placeholder="{{ I18ns.questions.form.linkPlaceholder }}"
    />
  </form>
</div>

<div class="footer">
  <hr class="m-0" />
  <div class="button-container">
    <button
      type="button"
      class="btn btn-outline-secondary me-3"
      aria-label="Close"
      (click)="activeOffcanvas.dismiss()"
    >
      {{ I18ns.shared.cancel }}
    </button>
    <ng-container *ngIf="isSubmitted; else elseTemplate">
      <input
        type="submit"
        [disabled]="questionForm && !questionForm.valid"
        class="btn btn-primary float-end"
        [value]="I18ns.shared.save"
        (click)="createQuestion()"
      />

      <button
        type="button"
        class="btn btn-danger me-3 float-end"
        (click)="changeStatus(QuestionSubmittedStatusEnum.Declined)"
      >
        {{ I18ns.shared.refuse }}
      </button>
    </ng-container>
    <ng-template #elseTemplate>
      <input
        type="submit"
        [disabled]="questionForm && !questionForm.valid"
        class="btn btn-primary float-end"
        [value]="I18ns.shared.save"
        (click)="createQuestion()"
      />
    </ng-template>
  </div>
</div>
